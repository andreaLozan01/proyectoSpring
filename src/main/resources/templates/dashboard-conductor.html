<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Conductor</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@heroicons/react@2.0.13/outline/index.min.css" rel="stylesheet"/>
    <style>
        body {
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://www.uts.edu.co/sitio/wp-content/uploads/2024/02/3.jpg') no-repeat center center/cover;
            background-attachment: fixed;
            color: #f5f5f5;
            font-family: 'Arial', sans-serif;
        }
        .sidebar {
            transition: width 0.2s ease;
        }
        .sidebar:hover {
            width: 250px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        button {
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        button:hover {
            background-color: #d4af37;
            transform: scale(1.02);
        }
        input, select {
            transition: border-color 0.2s ease;
        }
        input:focus, select:focus {
            border-color: #d4af37;
            outline: none;
        }
        .table-row:hover {
            background-color: rgba(212, 175, 55, 0.05);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            margin: 10% auto;
        }
        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }
        .timer {
            display: inline-block;
            font-weight: bold;
            color: #f5f5f5;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 8px;
        }
        .inactive-message {
            color: #ef4444;
            text-align: center;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .section.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: medium;
            transition: all 0.2s ease;
        }
        .action-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .action-button svg {
            width: 16px;
            height: 16px;
            margin-right: 4px;
        }
    </style>
</head>
<body class="flex min-h-screen">
    <!-- Barra lateral -->
    <aside class="sidebar w-16 lg:w-64 bg-gray-800 text-white p-4 flex flex-col h-screen fixed transition-all duration-200 z-50">
        <div class="mb-6">
            <img src="/logo.png" alt="Logo AR Carpooling" class="h-10 mx-auto mb-2">
            <h2 class="text-center text-lg font-semibold hidden lg:block">Carpooling UTS</h2>
        </div>
        <nav class="flex-1">
            <a href="#dashboard" class="block py-2 px-4 rounded-lg hover:bg-gray-700 mb-2">Dashboard</a>
            <a href="#routes" class="block py-2 px-4 rounded-lg hover:bg-gray-700 mb-2">Mis Rutas</a>
            <a href="#history" class="block py-2 px-4 rounded-lg hover:bg-gray-700 mb-2">Historial</a>
            <a href="#ratings" class="block py-2 px-4 rounded-lg hover:bg-gray-700 mb-2">Calificaciones</a>
        </nav>
        <div class="mt-auto">
            <button onclick="logout()" class="w-full py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600">Cerrar Sesión</button>
        </div>
    </aside>

    <!-- Contenido principal -->
    <main class="ml-16 lg:ml-64 p-6 flex-1">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-semibold">Panel de Conductor</h1>
            <div class="flex items-center space-x-4">
                <div id="userInfo" class="text-sm"></div>
                <div class="bg-gray-700 p-2 rounded-full">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                </div>
            </div>
        </div>

        <div id="inactiveMessage" class="inactive-message hidden">Cuenta inactiva</div>

        <!-- Sección para crear ruta -->
        <div id="createRouteSection" class="card p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">Crear Nueva Ruta</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="flex flex-col">
                    <label for="newOrigen" class="text-sm font-medium mb-1">Origen</label>
                    <input type="text" id="newOrigen" placeholder="Origen" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                    <div class="error text-red-500 text-xs mt-1 hidden" id="newOrigenError">Por favor, ingrese un origen.</div>
                </div>
                <div class="flex flex-col">
                    <label for="newDestino" class="text-sm font-medium mb-1">Destino</label>
                    <input type="text" id="newDestino" placeholder="Destino" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                    <div class="error text-red-500 text-xs mt-1 hidden" id="newDestinoError">Por favor, ingrese un destino.</div>
                </div>
                <div class="flex flex-col">
                    <label for="newFechaHora" class="text-sm font-medium mb-1">Fecha y Hora</label>
                    <input type="datetime-local" id="newFechaHora" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                    <div class="error text-red-500 text-xs mt-1 hidden" id="newFechaHoraError">Por favor, seleccione una fecha y hora.</div>
                </div>
                <div class="flex flex-col">
                    <label for="newCupos" class="text-sm font-medium mb-1">Cupos disponibles</label>
                    <input type="number" id="newCupos" placeholder="Cupos disponibles" min="1" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                    <div class="error text-red-500 text-xs mt-1 hidden" id="newCuposError">Por favor, ingrese un número de cupos válido.</div>
                </div>
                <div class="flex flex-col">
                    <label for="newPrecio" class="text-sm font-medium mb-1">Precio (0-4000 COP)</label>
                    <input type="number" id="newPrecio" placeholder="Precio" min="0" max="4000" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                    <div class="error text-red-500 text-xs mt-1 hidden" id="newPrecioError">El precio debe estar entre 0 y 4000 COP.</div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button onclick="createRoute()" class="bg-yellow-500 text-white font-medium py-2 px-4 rounded-lg">Crear Ruta</button>
            </div>
        </div>

        <!-- Sección para listar rutas activas -->
        <div class="card p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">Mis Rutas Activas</h2>
            <div class="overflow-x-auto">
                <table id="routesTable" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-700">
                            <th class="p-3 text-left border-b border-gray-600">ID</th>
                            <th class="p-3 text-left border-b border-gray-600">Origen</th>
                            <th class="p-3 text-left border-b border-gray-600">Destino</th>
                            <th class="p-3 text-left border-b border-gray-600">Fecha/Hora</th>
                            <th class="p-3 text-left border-b border-gray-600">Cupos</th>
                            <th class="p-3 text-left border-b border-gray-600">Precio (COP)</th>
                            <th class="p-3 text-left border-b border-gray-600">Estado</th>
                            <th class="p-3 text-left border-b border-gray-600">Tiempo en Ruta</th>
                            <th class="p-3 text-left border-b border-gray-600">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="routesTableBody" class="bg-transparent"></tbody>
                </table>
            </div>
        </div>

        <!-- Modal para editar ruta -->
        <div id="editRouteModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('editRouteModal')">×</span>
                <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Editar Ruta</h2>
                <input type="hidden" id="editRouteId">
                <div class="space-y-3">
                    <div class="flex flex-col">
                        <label for="editOrigen" class="text-sm font-medium mb-1 text-gray-800">Origen</label>
                        <input type="text" id="editOrigen" placeholder="Origen" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                        <div class="error text-red-500 text-xs mt-1 hidden" id="editOrigenError">Por favor, ingrese un origen.</div>
                    </div>
                    <div class="flex flex-col">
                        <label for="editDestino" class="text-sm font-medium mb-1 text-gray-800">Destino</label>
                        <input type="text" id="editDestino" placeholder="Destino" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                        <div class="error text-red-500 text-xs mt-1 hidden" id="editDestinoError">Por favor, ingrese un destino.</div>
                    </div>
                    <div class="flex flex-col">
                        <label for="editFechaHora" class="text-sm font-medium mb-1 text-gray-800">Fecha y Hora</label>
                        <input type="datetime-local" id="editFechaHora" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                        <div class="error text-red-500 text-xs mt-1 hidden" id="editFechaHoraError">Por favor, seleccione una fecha y hora.</div>
                    </div>
                    <div class="flex flex-col">
                        <label for="editCupos" class="text-sm font-medium mb-1 text-gray-800">Cupos disponibles</label>
                        <input type="number" id="editCupos" placeholder="Cupos disponibles" min="1" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                        <div class="error text-red-500 text-xs mt-1 hidden" id="editCuposError">Por favor, ingrese un número de cupos válido.</div>
                    </div>
                    <div class="flex flex-col">
                        <label for="editPrecio" class="text-sm font-medium mb-1 text-gray-800">Precio (0-4000 COP)</label>
                        <input type="number" id="editPrecio" placeholder="Precio" min="0" max="4000" class="p-2 border border-gray-200 rounded-lg bg-white text-gray-800">
                        <div class="error text-red-500 text-xs mt-1 hidden" id="editPrecioError">El precio debe estar entre 0 y 4000 COP.</div>
                    </div>
                    <button onclick="updateRoute()" class="w-full bg-yellow-500 text-white font-medium py-2 rounded-lg">Guardar Cambios</button>
                </div>
            </div>
        </div>

        <!-- Modal para gestionar solicitudes de pasajeros -->
        <div id="requestsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('requestsModal')">×</span>
                <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Solicitudes de Pasajeros</h2>
                <div class="overflow-x-auto">
                    <table id="requestsTable" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-3 text-left border-b border-gray-200 font-medium text-gray-800">ID Solicitud</th>
                                <th class="p-3 text-left border-b border-gray-200 font-medium text-gray-800">Pasajero ID</th>
                                <th class="p-3 text-left border-b border-gray-200 font-medium text-gray-800">Estado</th>
                                <th class="p-3 text-left border-b border-gray-200 font-medium text-gray-800">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody" class="bg-transparent"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sección para historial de rutas -->
        <div class="card p-4 mb-6">
            <h2 class="text-xl font-semibold mb-4">Historial de Rutas</h2>
            <div class="overflow-x-auto">
                <table id="historyTable" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-700">
                            <th class="p-3 text-left border-b border-gray-600">ID Ruta</th>
                            <th class="p-3 text-left border-b border-gray-600">Fecha/Hora</th>
                            <th class="p-3 text-left border-b border-gray-600">Origen</th>
                            <th class="p-3 text-left border-b border-gray-600">Destino</th>
                            <th class="p-3 text-left border-b border-gray-600">Pasajeros Confirmados</th>
                            <th class="p-3 text-left border-b border-gray-600">Precio (COP)</th>
                            <th class="p-3 text-left border-b border-gray-600">Duración</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-transparent"></tbody>
                </table>
            </div>
        </div>

        <!-- Sección para calificaciones -->
        <div class="card p-4">
            <h2 class="text-xl font-semibold mb-4">Mis Calificaciones</h2>
            <div class="overflow-x-auto">
                <table id="ratingsTable" class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-700">
                            <th class="p-3 text-left border-b border-gray-600">ID Calificación</th>
                            <th class="p-3 text-left border-b border-gray-600">Pasajero ID</th>
                            <th class="p-3 text-left border-b border-gray-600">Estrellas</th>
                            <th class="p-3 text-left border-b border-gray-600">Comentario</th>
                        </tr>
                    </thead>
                    <tbody id="ratingsTableBody" class="bg-transparent"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const conductorId = localStorage.getItem('userId');
        const currentRole = localStorage.getItem('rol');
        const timers = new Map(); // Mapa para almacenar temporizadores por ruta
        const durations = new Map(); // Mapa para almacenar la duración actual por ruta
        let isAccountInactive = false;

        // Validar acceso al dashboard y cargar datos
        document.addEventListener('DOMContentLoaded', async () => {
            if (!conductorId || !currentRole) {
                alert('Por favor, inicia sesión.');
                window.location.href = '/login';
                return;
            }

            if (currentRole !== 'conductor') {
                alert('Acceso denegado. Este dashboard es solo para conductores.');
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`/api/users/${conductorId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userInfo').textContent = `Usuario: ${user.nombre || conductorId} (Conductor)`;
                    // Verificar si la cuenta está inactiva
                    if (user.estado === 'INACTIVO') {
                        isAccountInactive = true;
                        disableFunctionalities();
                        // Mostrar mensaje de cuenta inactiva
                        document.getElementById('inactiveMessage').style.display = 'block';
                        alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                    }
                } else {
                    document.getElementById('userInfo').textContent = `Usuario: ${conductorId} (Conductor)`;
                }
            } catch (error) {
                console.error('Error al cargar información del usuario:', error);
                document.getElementById('userInfo').textContent = `Usuario: ${conductorId} (Conductor)`;
            }

            if (!isAccountInactive) {
                await loadRoutes();
                await loadHistory();
                await loadRatings();
            }
        });

        // Deshabilitar todas las funcionalidades
        function disableFunctionalities() {
            // Deshabilitar la sección de crear ruta
            const createRouteSection = document.getElementById('createRouteSection');
            createRouteSection.classList.add('disabled');

            // Deshabilitar botones de acciones en la tabla de rutas
            const actionButtons = document.querySelectorAll('#routesTableBody button');
            actionButtons.forEach(button => {
                button.disabled = true;
            });

            // Deshabilitar botones en el modal de solicitudes (si está abierto)
            const requestButtons = document.querySelectorAll('#requestsTableBody button');
            requestButtons.forEach(button => {
                button.disabled = true;
            });
        }

        // Función para crear una ruta
        async function createRoute() {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            const origen = document.getElementById('newOrigen').value;
            const destino = document.getElementById('newDestino').value;
            const fechaHora = document.getElementById('newFechaHora').value;
            const cupos = document.getElementById('newCupos').value;
            const precio = document.getElementById('newPrecio').value;

            // Validar campos obligatorios
            const origenError = document.getElementById('newOrigenError');
            const destinoError = document.getElementById('newDestinoError');
            const fechaHoraError = document.getElementById('newFechaHoraError');
            const cuposError = document.getElementById('newCuposError');
            const precioError = document.getElementById('newPrecioError');

            let isValid = true;

            if (!origen) {
                origenError.style.display = 'block';
                isValid = false;
            } else {
                origenError.style.display = 'none';
            }
            if (!destino) {
                destinoError.style.display = 'block';
                isValid = false;
            } else {
                destinoError.style.display = 'none';
            }
            if (!fechaHora) {
                fechaHoraError.style.display = 'block';
                isValid = false;
            } else {
                fechaHoraError.style.display = 'none';
            }
            const cuposNum = parseInt(cupos);
            if (!cupos || cuposNum <= 0) {
                cuposError.style.display = 'block';
                isValid = false;
            } else {
                cuposError.style.display = 'none';
            }
            const precioNum = parseInt(precio);
            if (!precio || precioNum > 4000 || precioNum < 0) {
                precioError.style.display = 'block';
                isValid = false;
            } else {
                precioError.style.display = 'none';
            }

            if (isValid) {
                try {
                    const response = await fetch('/api/rutas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conductorId,
                            origen,
                            destino,
                            fechaHora,
                            cuposDisponibles: cuposNum,
                            precio: precioNum,
                            activa: true,
                            estado: 'ACTIVA',
                            pasajerosConfirmados: [],
                            solicitudesPendientes: [],
                            duracion: 0
                        })
                    });
                    if (response.ok) {
                        alert('Ruta creada exitosamente.');
                        document.getElementById('newOrigen').value = '';
                        document.getElementById('newDestino').value = '';
                        document.getElementById('newFechaHora').value = '';
                        document.getElementById('newCupos').value = '';
                        document.getElementById('newPrecio').value = '';
                        await loadRoutes();
                    } else {
                        alert('Error al crear ruta: ' + (await response.text()));
                    }
                } catch (error) {
                    alert('Error al crear ruta: ' + error.message);
                }
            }
        }

        // Función para cargar las rutas activas del conductor
        async function loadRoutes() {
            try {
                const currentDate = new Date('2025-05-23T22:54:00-05:00'); // Fecha actual: 23 de mayo de 2025, 10:54 PM -05
                const response = await fetch('/api/rutas', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const routes = await response.json();
                    const filteredRoutes = routes.filter(route => route.conductorId === conductorId && route.activa && new Date(route.fechaHora) >= currentDate);
                    const tableBody = document.getElementById('routesTableBody');
                    tableBody.innerHTML = '';

                    if (filteredRoutes.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="9" class="p-3 text-center border-b border-gray-600">No hay rutas activas.</td></tr>';
                    } else {
                        filteredRoutes.forEach(route => {
                            const row = document.createElement('tr');
                            row.classList.add('table-row');
                            row.innerHTML = `
                                <td class="p-3 border-b border-gray-600">${route.rutaId}</td>
                                <td class="p-3 border-b border-gray-600">${route.origen}</td>
                                <td class="p-3 border-b border-gray-600">${route.destino}</td>
                                <td class="p-3 border-b border-gray-600">${new Date(route.fechaHora).toLocaleString('es-CO', { timeZone: 'America/Bogota' })}</td>
                                <td class="p-3 border-b border-gray-600">${route.cuposDisponibles}</td>
                                <td class="p-3 border-b border-gray-600">${route.precio} COP</td>
                                <td class="p-3 border-b border-gray-600">${route.estado}</td>
                                <td class="p-3 border-b border-gray-600">
                                    ${route.estado === 'EN CURSO' ? 
                                        `<span class="timer" id="timer-${route.rutaId}">${formatTime(durations.get(route.rutaId) || route.duracion || 0)}</span>` : 
                                        'No iniciada'
                                    }
                                </td>
                                <td class="p-3 border-b border-gray-600">
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="openEditRouteModal('${route.rutaId}')" ${isAccountInactive || route.estado === 'EN CURSO' ? 'disabled' : ''} class="action-button bg-yellow-500 text-white" title="Editar Ruta">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                            </svg>
                                            Editar
                                        </button>
                                        <button onclick="deleteRoute('${route.rutaId}')" ${isAccountInactive || route.estado === 'EN CURSO' ? 'disabled' : ''} class="action-button bg-red-500 text-white" title="Eliminar Ruta">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                            Eliminar
                                        </button>
                                        <button onclick="viewRequests('${route.rutaId}')" ${isAccountInactive ? 'disabled' : ''} class="action-button bg-blue-500 text-white" title="Ver Solicitudes">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                            Solicitudes
                                        </button>
                                        <button onclick="startRoute('${route.rutaId}')" ${isAccountInactive || route.estado !== 'ACTIVA' ? 'disabled' : ''} class="action-button bg-green-500 text-white" title="Iniciar Ruta">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                            </svg>
                                            Iniciar
                                        </button>
                                        <button onclick="endRoute('${route.rutaId}')" ${isAccountInactive || route.estado !== 'EN CURSO' ? 'disabled' : ''} class="action-button bg-red-600 text-white" title="Finalizar Ruta">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m-7-3h10" />
                                            </svg>
                                            Finalizar
                                        </button>
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(row);

                            // Si la ruta está en curso, iniciar el temporizador
                            if (route.estado === 'EN CURSO' && !isAccountInactive) {
                                startTimer(route.rutaId, durations.get(route.rutaId) || route.duracion || 0);
                            }
                        });
                    }
                } else {
                    alert('Error al cargar rutas: ' + (await response.text()));
                }
            } catch (error) {
                console.error('Error al cargar rutas:', error);
                alert('Error al cargar rutas: ' + error.message);
            }
        }

        // Función para iniciar una ruta y comenzar el temporizador
        async function startRoute(rutaId) {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            try {
                console.log('Intentando iniciar ruta con ID:', rutaId);
                const route = await getRoute(rutaId);
                console.log('Ruta encontrada:', route);
                route.estado = 'EN CURSO';
                route.duracion = 0;
                const response = await fetch(`/api/rutas/${rutaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(route)
                });
                console.log('Respuesta del servidor:', response);
                if (response.ok) {
                    alert('Ruta iniciada exitosamente.');
                    durations.set(rutaId, 0);
                    await loadRoutes();
                    startTimer(rutaId, 0);
                } else {
                    const errorText = await response.text();
                    alert('Error al iniciar ruta: ' + errorText);
                }
            } catch (error) {
                console.error('Error al iniciar ruta:', error);
                alert('Error al iniciar ruta: ' + error.message);
            }
        }

        // Función para iniciar el temporizador
        function startTimer(rutaId, initialDuration) {
            if (timers.has(rutaId) || isAccountInactive) return;

            let duration = initialDuration;
            durations.set(rutaId, duration);
            const timerElement = document.getElementById(`timer-${rutaId}`);
            if (!timerElement) return;

            const interval = setInterval(async () => {
                duration++;
                durations.set(rutaId, duration);
                timerElement.textContent = formatTime(duration);

                if (duration % 5 === 0) {
                    const route = await getRoute(rutaId);
                    if (route && route.estado === 'EN CURSO' && !isAccountInactive) {
                        route.duracion = duration;
                        const response = await fetch(`/api/rutas/${rutaId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(route)
                        });
                        if (!response.ok) {
                            console.error('Error al actualizar duración en el backend:', await response.text());
                        }
                    } else {
                        clearInterval(interval);
                        timers.delete(rutaId);
                        durations.delete(rutaId);
                    }
                }
            }, 1000);

            timers.set(rutaId, interval);
        }

        // Función para formatear el tiempo en hh:mm:ss
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Función para finalizar una ruta y detener el temporizador
        async function endRoute(rutaId) {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            try {
                const route = await getRoute(rutaId);
                const duration = durations.get(rutaId) || route.duracion || 0;
                route.estado = 'PASADA';
                route.activa = false;
                route.duracion = duration;
                const response = await fetch(`/api/rutas/${rutaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(route)
                });
                if (response.ok) {
                    alert('Ruta finalizada exitosamente. Duración: ' + formatTime(duration));
                    if (timers.has(rutaId)) {
                        clearInterval(timers.get(rutaId));
                        timers.delete(rutaId);
                        durations.delete(rutaId);
                    }
                    await loadRoutes();
                    await loadHistory();
                } else {
                    alert('Error al finalizar ruta: ' + (await response.text()));
                }
            } catch (error) {
                console.error('Error al finalizar ruta:', error);
                alert('Error al finalizar ruta: ' + error.message);
            }
        }

        // Función para abrir el modal de edición de ruta
        async function openEditRouteModal(rutaId) {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            const route = await getRoute(rutaId);
            document.getElementById('editRouteId').value = rutaId;
            document.getElementById('editOrigen').value = route.origen;
            document.getElementById('editDestino').value = route.destino;
            document.getElementById('editFechaHora').value = route.fechaHora.slice(0, 16);
            document.getElementById('editCupos').value = route.cuposDisponibles;
            document.getElementById('editPrecio').value = route.precio;
            document.getElementById('editRouteModal').style.display = 'flex';
        }

        // Función para actualizar una ruta
        async function updateRoute() {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            const rutaId = document.getElementById('editRouteId').value;
            const origen = document.getElementById('editOrigen').value;
            const destino = document.getElementById('editDestino').value;
            const fechaHora = document.getElementById('editFechaHora').value;
            const cupos = document.getElementById('editCupos').value;
            const precio = document.getElementById('editPrecio').value;

            // Validar campos obligatorios
            const origenError = document.getElementById('editOrigenError');
            const destinoError = document.getElementById('editDestinoError');
            const fechaHoraError = document.getElementById('editFechaHoraError');
            const cuposError = document.getElementById('editCuposError');
            const precioError = document.getElementById('editPrecioError');

            let isValid = true;

            if (!origen) {
                origenError.style.display = 'block';
                isValid = false;
            } else {
                origenError.style.display = 'none';
            }
            if (!destino) {
                destinoError.style.display = 'block';
                isValid = false;
            } else {
                destinoError.style.display = 'none';
            }
            if (!fechaHora) {
                fechaHoraError.style.display = 'block';
                isValid = false;
            } else {
                fechaHoraError.style.display = 'none';
            }
            const cuposNum = parseInt(cupos);
            if (!cupos || cuposNum <= 0) {
                cuposError.style.display = 'block';
                isValid = false;
            } else {
                cuposError.style.display = 'none';
            }
            const precioNum = parseInt(precio);
            if (!precio || precioNum > 4000 || precioNum < 0) {
                precioError.style.display = 'block';
                isValid = false;
            } else {
                precioError.style.display = 'none';
            }

            if (isValid) {
                try {
                    const response = await fetch(`/api/rutas/${rutaId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            origen,
                            destino,
                            fechaHora,
                            cuposDisponibles: cuposNum,
                            precio: precioNum,
                            activa: true,
                            estado: 'ACTIVA'
                        })
                    });
                    if (response.ok) {
                        alert('Ruta actualizada exitosamente.');
                        closeModal('editRouteModal');
                        await loadRoutes();
                    } else {
                        alert('Error al actualizar ruta: ' + (await response.text()));
                    }
                } catch (error) {
                    alert('Error al actualizar ruta: ' + error.message);
                }
            }
        }

        // Función para eliminar una ruta
        async function deleteRoute(rutaId) {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            if (!confirm('¿Estás seguro de eliminar esta ruta?')) return;
            try {
                const response = await fetch(`/api/rutas/${rutaId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    alert('Ruta eliminada exitosamente.');
                    await loadRoutes();
                } else {
                    alert('Error al eliminar ruta: ' + (await response.text()));
                }
            } catch (error) {
                alert('Error al eliminar ruta: ' + error.message);
            }
        }

        // Función para ver solicitudes de pasajeros
        async function viewRequests(rutaId) {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            try {
                const response = await fetch(`/api/solicitudes/ruta/${rutaId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const requests = await response.json();
                    const tableBody = document.getElementById('requestsTableBody');
                    tableBody.innerHTML = '';
                    if (requests.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center border-b border-gray-200">No hay solicitudes para esta ruta.</td></tr>';
                    } else {
                        requests.forEach(request => {
                            const row = document.createElement('tr');
                            row.classList.add('table-row');
                            row.innerHTML = `
                                <td class="p-3 border-b border-gray-200">${request.solicitudId}</td>
                                <td class="p-3 border-b border-gray-200">${request.pasajeroId}</td>
                                <td class="p-3 border-b border-gray-200">${request.estado}</td>
                                <td class="p-3 border-b border-gray-200">
                                    ${request.estado === 'PENDIENTE' ? `
                                        <button onclick="updateRequest('${rutaId}', '${request.solicitudId}', 'ACEPTADO')" ${isAccountInactive ? 'disabled' : ''} class="bg-green-500 text-white font-medium py-1 px-3 rounded-lg mr-2">Aceptar</button>
                                        <button onclick="updateRequest('${rutaId}', '${request.solicitudId}', 'RECHAZADO')" ${isAccountInactive ? 'disabled' : ''} class="bg-red-500 text-white font-medium py-1 px-3 rounded-lg mr-2">Rechazar</button>
                                    ` : ''}
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                    document.getElementById('requestsModal').style.display = 'flex';
                } else {
                    alert('Error al cargar solicitudes: ' + (await response.text()));
                }
            } catch (error) {
                alert('Error al cargar solicitudes: ' + error.message);
            }
        }

        // Función para actualizar el estado de una solicitud
        async function updateRequest(rutaId, solicitudId, estado) {
            if (isAccountInactive) {
                alert('Su cuenta está inactiva por órdenes superiores. Comuníquese con el operador.');
                return;
            }
            try {
                const response = await fetch(`/api/solicitudes/${solicitudId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado })
                });
                if (response.ok) {
                    alert(`Solicitud ${estado.toLowerCase()} exitosamente.`);
                    await viewRequests(rutaId);
                    if (estado === 'ACEPTADO') await updateRouteCapacity(rutaId);
                } else {
                    alert('Error al actualizar solicitud: ' + (await response.text()));
                }
            } catch (error) {
                alert('Error al actualizar solicitud: ' + error.message);
            }
        }

        // Función para actualizar la capacidad de la ruta tras aceptar una solicitud
        async function updateRouteCapacity(rutaId) {
            const route = await getRoute(rutaId);
            if (route.cuposDisponibles > 0) {
                route.cuposDisponibles -= 1;
                if (route.cuposDisponibles === 0) route.activa = false;
                await fetch(`/api/rutas/${rutaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(route)
                });
            }
        }

        // Función para cargar el historial de rutas
        async function loadHistory() {
            try {
                const response = await fetch('/api/rutas', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const routes = await response.json();
                    const filteredRoutes = routes.filter(route => route.conductorId === conductorId && route.estado === 'PASADA');
                    const tableBody = document.getElementById('historyTableBody');
                    tableBody.innerHTML = '';
                    if (filteredRoutes.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" class="p-3 text-center border-b border-gray-600">No hay historial de rutas.</td></tr>';
                    } else {
                        filteredRoutes.forEach(route => {
                            const row = document.createElement('tr');
                            row.classList.add('table-row');
                            row.innerHTML = `
                                <td class="p-3 border-b border-gray-600">${route.rutaId}</td>
                                <td class="p-3 border-b border-gray-600">${new Date(route.fechaHora).toLocaleString('es-CO', { timeZone: 'America/Bogota' })}</td>
                                <td class="p-3 border-b border-gray-600">${route.origen}</td>
                                <td class="p-3 border-b border-gray-600">${route.destino}</td>
                                <td class="p-3 border-b border-gray-600">${route.pasajerosConfirmados ? route.pasajerosConfirmados.join(', ') : 'Ninguno'}</td>
                                <td class="p-3 border-b border-gray-600">${route.precio} COP</td>
                                <td class="p-3 border-b border-gray-600">${route.duracion > 0 ? formatTime(route.duracion) : 'No registrada'}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                } else {
                    alert('Error al cargar historial de rutas: ' + (await response.text()));
                }
            } catch (error) {
                alert('Error al cargar historial de rutas: ' + error.message);
            }
        }

        // Función para cargar calificaciones
        async function loadRatings() {
            try {
                const response = await fetch('/api/calificaciones', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const ratings = await response.json();
                    const filteredRatings = ratings.filter(rating => rating.conductorId === conductorId && !rating.eliminado);
                    const tableBody = document.getElementById('ratingsTableBody');
                    tableBody.innerHTML = '';
                    if (filteredRatings.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="p-3 text-center border-b border-gray-600">No hay calificaciones.</td></tr>';
                    } else {
                        filteredRatings.forEach(rating => {
                            const row = document.createElement('tr');
                            row.classList.add('table-row');
                            row.innerHTML = `
                                <td class="p-3 border-b border-gray-600">${rating.calificacionId}</td>
                                <td class="p-3 border-b border-gray-600">${rating.pasajeroId}</td>
                                <td class="p-3 border-b border-gray-600">${rating.estrellas}</td>
                                <td class="p-3 border-b border-gray-600">${rating.comentario || 'Sin comentario'}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                } else {
                    alert('Error al cargar calificaciones: ' + (await response.text()));
                }
            } catch (error) {
                alert('Error al cargar calificaciones: ' + error.message);
            }
        }

        // Función auxiliar para obtener una ruta
        async function getRoute(rutaId) {
            const response = await fetch('/api/rutas', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });
            const routes = await response.json();
            return routes.find(route => route.rutaId === rutaId);
        }

        // Función para cerrar modales
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Función para cerrar sesión
        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('rol');
            window.location.href = '/login';
        }
    </script>
</body>
</html>